<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Binary Bot Pro AI</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0"></script>

    <style>
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 255, 150, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #00ff99;
            border-radius: 10px;
            box-shadow:
                0 0 5px #00ff99,
                0 0 10px rgba(0,255,150,0.6),
                inset 0 0 5px rgba(0,0,0,0.6);
            transition: 0.3s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00ffaa;
            box-shadow:
                0 0 8px #00ffaa,
                0 0 14px rgba(0,255,150,0.9);
        }
        body {
            background: radial-gradient(circle at top, #0f172a, #000);
            font-family: monospace;
        }

        .card {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 255, 150, 0.2);
            box-shadow: 0 0 20px rgba(0, 255, 150, 0.1);
        }

        .logbox {
            background: #050b18;
        }

        .glow {
            box-shadow: 0 0 12px rgba(0, 255, 150, 0.35);
        }
    </style>
</head>

<body class="text-green-400 p-4 sm:p-6 flex flex-col sm:h-screen h-full">

    <h1 class="text-2xl sm:text-3xl font-bold mb-4 text-green-300 text-center sm:text-center">
        BINARY BOT PRO AI
    </h1>

    <!-- GRID RESPONSIVE -->
    <div class="
        grid gap-4 sm:gap-6
        grid-cols-1
        sm:grid-cols-2
        xl:grid-cols-4
        mb-6">
        <!-- CONTROL -->
        <div class="card p-4 sm:p-5 rounded-xl">
            <h2 class="text-green-300 mb-2 text-sm sm:text-base">CONTROL</h2>
            <input id="token" type="password" placeholder="API Token"
                class="w-full text-black p-2 mb-3 rounded text-sm"
                value="XFOzhqtHz0gI04U">
            
            <div class="flex gap-3">
                <input id="stake" type="number" placeholder="ST"
                    class="w-full text-black p-2 mb-3 rounded text-sm" value="0.35">
    
                <input id="martingale" type="number" placeholder="MG"
                    class="w-full text-black p-2 mb-3 rounded text-sm" value="2.1">

                <input id="targetProfit" type="number" placeholder="TP"
                    class="w-full text-black p-2 mb-3 rounded text-sm">
    
                <input id="stopLoss" type="number" placeholder="SL"
                    class="w-full text-black p-2 mb-3 rounded text-sm">
            </div>

            <button onclick="startBot()"
                id="startBtn"
                class="text-white bg-green-600 hover:bg-green-500 active:scale-95 transition w-full py-2 rounded glow text-sm sm:text-base">
                START BOT
            </button>

            <button onclick="stopBot()"
                id="stopBtn"
                class="text-white bg-red-600 hover:bg-red-500 active:scale-95 transition w-full py-2 rounded glow text-sm sm:text-base hidden">
                STOP BOT
            </button>

            <div class="mt-2 text-xs sm:text-sm">
                Status: <span id="status">Idle</span>
            </div>
        </div>

        <!-- ACCOUNT -->
        <div class="card p-4 sm:p-5 rounded-xl">
            <h2 class="text-green-300 mb-2 text-sm sm:text-base">ACCOUNT</h2>
            Balance: <span id="balance">--</span><br>
            Profit/Loss: <span id="pnl">--</span><br>
            Drawdown: <span id="dd">--</span>
        </div>

        <!-- MODEL -->
        <div class="card p-4 sm:p-5 rounded-xl">
            <h2 class="text-green-300 mb-2 text-sm sm:text-base">MODEL</h2>
            Price: <span id="lastPrice">--</span><br>
            Prob: <span id="prob">--</span><br>
            Stake: <span id="stakeView">--</span><br>
            Loss Streak: <span id="ls">--</span><br>
            Status: <span id="modelStatus">--</span>
        </div>

        <!-- PERFORMANCE -->
        <div class="card p-4 sm:p-5 rounded-xl">
            <h2 class="text-green-300 mb-2 text-sm sm:text-base">PERFORMANCE</h2>
            Trades: <span id="trades">--</span><br>
            Wins: <span id="wins">--</span><br>
            Losses: <span id="losses">--</span><br>
            Winrate: <span id="wr">--</span>
        </div>
    </div>

    <!-- LOG FULL WIDTH -->
    <div class="card logbox p-4 rounded-xl h-64 sm:h-80 overflow-y-auto text-xs sm:text-sm" id="log">
        <h2 class="text-green-300 mb-2 text-sm sm:text-base">LOG</h2>
    </div>

    <script>
        const APP_ID = 1089;
        const SYMBOL = "R_100";

        let ws, model, prices = [];
        let balance = 0, pnl = 0, peak = 0, maxDD = 0;
        let trades = 0, wins = 0;
        let stake = document.getElementById("stake").value*1, baseStake = stake, lossStreak = 0;
        let isTrading = false, isReady = false;
        let tickCounter = 0;
        let targetProfit = null;
        let stopLoss = null;
        let martingale = null;

        const TIMESTEPS = 20;
        const FEATURES = 4;

        /* ========= LOG ========= */
        function log(msg, color = "text-green-400") {
            const el = document.getElementById("log");
            el.innerHTML += `<div class="${color}">${new Date().toLocaleTimeString()} ▸ ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        /* ========= MODEL ========= */ 
        function getSlope(period = 20) {

            if (prices.length < period) return 0;

            let xSum = 0, ySum = 0, xySum = 0, xxSum = 0;

            for (let i = 0; i < period; i++) {
                const x = i;
                const y = prices[prices.length - period + i];

                xSum += x;
                ySum += y;
                xySum += x * y;
                xxSum += x * x;
            }

            const slope =
                (period * xySum - xSum * ySum) /
                (period * xxSum - xSum * xSum);

            return slope;
        }
        
        /* ========= FUNCTION ========= */
        
        function getRSI(period = 14) {
            if (prices.length < period + 1) return 50;
            let gains = 0, losses = 0;
            for (let i = prices.length - period; i < prices.length; i++) {
                let diff = prices[i] - prices[i - 1];
                if (diff >= 0) gains += diff;
                else losses -= diff;
            }
            if (losses === 0) return 100;
            let rs = (gains / period) / (losses / period);
            return 100 - (100 / (1 + rs));
        }
        
        function getROC(period = 5) {
            if (prices.length < period) return 0;
            const current = prices.at(-1);
            const old = prices.at(-period);
            return ((current - old) / old) * 100;
        }
            
        function ema(period) {
            const k = 2 / (period + 1);
            let ema = prices[prices.length - period];

            for (let i = prices.length - period + 1; i < prices.length; i++) {
                ema = prices[i] * k + ema * (1 - k);
            }

            return ema;
        }

        function getVolatility() {

            if (prices.length < 10) return 0;

            const slice = prices.slice(-10);
            const mean = slice.reduce((a,b)=>a+b,0)/slice.length;
            const variance = slice.reduce((a,b)=>a+(b-mean)**2,0)/slice.length;

            return Math.sqrt(variance);
        }

        function getMomentum() {

            if (prices.length < 4) return 0;

            return (
                (prices.at(-1) - prices.at(-2)) +
                (prices.at(-2) - prices.at(-3)) +
                (prices.at(-3) - prices.at(-4))
            );
        }


        /* ========= PREDICT ========= */
        function predict() {
            if (prices.length < 30) return;
            const emaFast = ema(5);
            const emaSlow = ema(20);
            const slope = getSlope(20);
            const vol = getVolatility();
            const rsi = getRSI(14);
            const roc = getROC(5);
            const trendStrength = Math.abs(emaFast - emaSlow);
            
            if (!isReady || isTrading) return;
            if (vol < 0.0001) return; 
            const isOversold = rsi < 30 && roc < -0.02;
            const upTrend = emaFast > emaSlow && slope > 0.02; // เทรนด์ขาลงแต่ความชันเริ่มลดลง
            const isOverbought = rsi > 70 && roc > 0.02;
            const downTrend = emaFast < emaSlow && slope < -0.02; // เทรนด์ขาขึ้นแต่ความชันเริ่มลดลง
            
            document.getElementById("prob").innerText = `[CALL] ${isOversold?1:0}${downTrend?1:0} | [PUT] ${isOverbought?1:0}${upTrend?1:0}`;
            if (isOversold && downTrend) {
                buy("PUT");
                return;
            }
           
            if (isOverbought && upTrend) {
                buy("CALL");
                return;
            }
        }


        /* ========= BUY ========= */
        function buy(type) {
            if (!ws || ws.readyState !== 1) return;
            isTrading = true;
            document.getElementById("status").innerText = "Trading";
            document.getElementById("modelStatus").innerText = "Trading...";
            log("BUY " + type + " | Stake " + stake, "text-yellow-400");

            ws.send(JSON.stringify({
                proposal: 1,
                amount: stake,
                basis: "stake",
                contract_type: type,
                currency: "USD",
                duration: 5,
                duration_unit: "t",
                symbol: SYMBOL
            }));
        }

        /* ========= STATS ========= */
        function updateStats(profit) {
            trades++;
            if (profit > 0) wins++;
            pnl += profit;
            if (pnl > peak) peak = pnl;
            let dd = peak - pnl;
            if (dd > maxDD) maxDD = dd;

            document.getElementById("pnl").innerText = pnl.toFixed(2);
            document.getElementById("pnl").className = pnl >= 0 ? "text-green-400" : "text-red-500";

            document.getElementById("trades").innerText = trades;
            document.getElementById("wins").innerText = wins;
            document.getElementById("losses").innerText = trades-wins;

            let wr = ((wins / trades) * 100) || 0;
            document.getElementById("wr").innerText = wr.toFixed(1) + "%";
            document.getElementById("wr").className = wr >= 55 ? "text-green-400" : "text-red-500";

            document.getElementById("dd").innerText = maxDD.toFixed(2);

            log("Result " + profit.toFixed(2),
                profit > 0 ? "text-green-400" : "text-red-500");

            // ===============================
            // CHECK TARGET PROFIT
            // ===============================
            if (targetProfit !== 0 && pnl >= targetProfit) {
                stopBot("Target Profit " + pnl.toFixed(2) + "$", "text-green-500");
            }

            // ===============================
            // CHECK STOP LOSS
            // ===============================
            if (stopLoss !== 0 && pnl <= -stopLoss) {
                stopBot("Stop Loss " + pnl.toFixed(2) + "$", "text-red-500");
            }
            
        }


        /* ========= START ========= */

        async function startBot() {
            toggleButtons(true);
            document.getElementById("status").innerText = "Loading";
            const token = document.getElementById("token").value;

            targetProfit = document.getElementById("targetProfit").value*1;
            stopLoss = document.getElementById("stopLoss").value*1;

            stake = document.getElementById("stake").value*1;
            baseStake = stake;
            martingale = document.getElementById("martingale").value*1;

            ws = new WebSocket("wss://ws.derivws.com/websockets/v3?app_id=" + APP_ID);
            ws.onopen = () => ws.send(JSON.stringify({ authorize: token }));

            ws.onmessage = async (msg) => {
                const data = JSON.parse(msg.data);
                if (data.error) {
                    log("API ERROR: " + data.error.message, "text-red-500");
                    isTrading = false;
                    document.getElementById("status").innerText = "Live";
                    return;
                }
                if (!data.msg_type) return;

                switch (data.msg_type) {

                    case "authorize":
                        log("Authorized", "text-blue-400");
                        // ✅ SUBSCRIBE BALANCE
                        ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
                        ws.send(JSON.stringify({ ticks: SYMBOL, subscribe: 1 }));
                        ws.send(JSON.stringify({
                            ticks_history: SYMBOL,
                            count: 1000,
                            end: "latest",
                            style: "ticks"
                        }));
                        document.getElementById("stakeView").innerText = stake.toFixed(2);
                        // initChart();
                        break;

                    case "history":
                        prices = data.history.prices.map(p => parseFloat(p));
                        document.getElementById("modelStatus").innerText = "Training model...";
                        isReady = true;
                        document.getElementById("status").innerText = "Live";
                        break;
                    case "balance":
                        if (data.balance && data.balance.balance !== undefined) {
                            balance = parseFloat(data.balance.balance);
                            document.getElementById("balance").innerText = balance.toFixed(2);
                        }
                        break;
                    case "tick":
                        prices.push(data.tick.quote);
                        if (prices.length > 1200) prices.shift();

                        const price = parseFloat(data.tick.quote);
                        const priceEl = document.getElementById("lastPrice");

                        priceEl.innerText = price.toFixed(2);
                        
                        //tickCounter++;

                        //if (tickCounter >= retrainInterval) {
                        //    tickCounter = 0;
                        //    log("Retraining Model...", "text-blue-400");
                        //    await trainModel();
                        //}

                        predict();
                        break;
                        
                    case "proposal":
                        ws.send(JSON.stringify({
                            buy: data.proposal.id,
                            price: stake
                        }));
                        break;
                        
                    case "buy":
                        ws.send(JSON.stringify({
                            proposal_open_contract: 1,
                            contract_id: data.buy.contract_id,
                            subscribe: 1
                        }));
                        break;

                    case "proposal_open_contract":
                        if (data.proposal_open_contract.is_sold) {
                            let profit = parseFloat(data.proposal_open_contract.profit);
                            if (profit > 0) { stake = baseStake; lossStreak = 0; }
                            else { lossStreak++; stake = parseFloat((stake * martingale).toFixed(2)); }
                            updateStats(profit);
                            document.getElementById("stakeView").innerText = stake;
                            document.getElementById("ls").innerText = lossStreak;
                            isTrading = false;
                            document.getElementById("modelStatus").innerText = "Training Model...";
                        }
                        break;
                }
            };
        }

        function stopBot(reason = "Stopped", style = "text-red-400") {
            isTrading = false;
            isReady = false;

            if (ws) {
                ws.close();
                ws = null;
            }
            toggleButtons(false);
            document.getElementById("status").innerText = "Stopped";
            log("BOT STOPPED | " + reason, style);
        }

        function toggleButtons(isRunning) {
            const startBtn = document.getElementById("startBtn");
            const stopBtn = document.getElementById("stopBtn");
            const inputs = ["token", "targetProfit", "stopLoss", "stake", "martingale"];

            if (isRunning) {
                startBtn.classList.add("hidden");
                stopBtn.classList.remove("hidden");
                inputs.forEach(id => {
                    const el = document.getElementById(id);
                    el.disabled = true
                });
            } else {
                startBtn.classList.remove("hidden");
                stopBtn.classList.add("hidden");
                inputs.forEach(id => {
                    const el = document.getElementById(id);
                    el.disabled = false;
                });
            }
        }



    </script>

</body>

</html>
